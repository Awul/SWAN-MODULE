<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="author" content="SWAN Team" />
      <link rel="shortcut icon" href="../../img/favicon.ico" />
    <title>File led_strip_spi_dev.c - SWAN Module Documentation</title>
    <link rel="stylesheet" href="../../css/theme.css" />
    <link rel="stylesheet" href="../../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "File led_strip_spi_dev.c";
        var mkdocs_page_input_path = "swan\\led__strip__spi__dev_8c_source.md";
        var mkdocs_page_url = null;
      </script>
    
    <!--[if lt IE 9]>
      <script src="../../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
      <script>hljs.highlightAll();</script> 
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href="../.." class="icon icon-home"> SWAN Module Documentation
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../..">Home</a>
                </li>
              </ul>
              <p class="caption"><span class="caption-text">Getting Started</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../getting-started/overview/">Overview</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../getting-started/build/">Build & Flash</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">API Reference</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../">Overview</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../modules/">Modules</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Guides</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../guides/architecture/">Architecture</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../guides/style/">Coding Style</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">About</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../about/license/">License</a>
                  </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../..">SWAN Module Documentation</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../.." class="icon icon-home" aria-label="Docs"></a></li>
      <li class="breadcrumb-item active">File led_strip_spi_dev.c</li>
    <li class="wy-breadcrumbs-aside">
          <a href="https://github.com/Awul/SWAN-MODULE/edit/master/docs/swan/led__strip__spi__dev_8c_source.md">Edit on Awul/SWAN-MODULE</a>
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="file-led_strip_spi_devc">File led_strip_spi_dev.c</h1>
<p><a href="../files/"><strong>File List</strong></a> <strong>&gt;</strong> <a href="../dir_ed75a055ae422585327f9cac7433a4c6/"><strong>blink</strong></a> <strong>&gt;</strong> <a href="../dir_f14b78939adc8414aa21d6af988468d0/"><strong>managed_components</strong></a> <strong>&gt;</strong> <a href="../dir_d0251c514b1be4d4f41659a309ca9490/"><strong>espressif__led_strip</strong></a> <strong>&gt;</strong> <a href="../dir_163002825b6da09af3d0cb3d07e787f0/"><strong>src</strong></a> <strong>&gt;</strong> <a href="../led__strip__spi__dev_8c/"><strong>led_strip_spi_dev.c</strong></a></p>
<p><a href="../led__strip__spi__dev_8c/">Go to the documentation of this file</a></p>
<pre><code class="language-C++">/*
 * SPDX-FileCopyrightText: 2022-2024 Espressif Systems (Shanghai) CO LTD
 *
 * SPDX-License-Identifier: Apache-2.0
 */
#include &lt;stdlib.h&gt;
#include &lt;string.h&gt;
#include &lt;sys/cdefs.h&gt;
#include &quot;esp_log.h&quot;
#include &quot;esp_check.h&quot;
#include &quot;esp_rom_gpio.h&quot;
#include &quot;soc/spi_periph.h&quot;
#include &quot;led_strip.h&quot;
#include &quot;led_strip_interface.h&quot;
#include &quot;esp_heap_caps.h&quot;

#define LED_STRIP_SPI_DEFAULT_RESOLUTION (2.5 * 1000 * 1000) // 2.5MHz resolution
#define LED_STRIP_SPI_DEFAULT_TRANS_QUEUE_SIZE 4

#define SPI_BYTES_PER_COLOR_BYTE 3
#define SPI_BITS_PER_COLOR_BYTE (SPI_BYTES_PER_COLOR_BYTE * 8)

static const char *TAG = &quot;led_strip_spi&quot;;

typedef struct {
    led_strip_t base;
    spi_host_device_t spi_host;
    spi_device_handle_t spi_device;
    uint32_t strip_len;
    uint8_t bytes_per_pixel;
    led_color_component_format_t component_fmt;
    uint8_t pixel_buf[];
} led_strip_spi_obj;

// please make sure to zero-initialize the buf before calling this function
static void __led_strip_spi_bit(uint8_t data, uint8_t *buf)
{
    // Each color of 1 bit is represented by 3 bits of SPI, low_level:100 ,high_level:110
    // So a color byte occupies 3 bytes of SPI.
    *(buf + 2) |= data &amp; BIT(0) ? BIT(2) | BIT(1) : BIT(2);
    *(buf + 2) |= data &amp; BIT(1) ? BIT(5) | BIT(4) : BIT(5);
    *(buf + 2) |= data &amp; BIT(2) ? BIT(7) : 0x00;
    *(buf + 1) |= BIT(0);
    *(buf + 1) |= data &amp; BIT(3) ? BIT(3) | BIT(2) : BIT(3);
    *(buf + 1) |= data &amp; BIT(4) ? BIT(6) | BIT(5) : BIT(6);
    *(buf + 0) |= data &amp; BIT(5) ? BIT(1) | BIT(0) : BIT(1);
    *(buf + 0) |= data &amp; BIT(6) ? BIT(4) | BIT(3) : BIT(4);
    *(buf + 0) |= data &amp; BIT(7) ? BIT(7) | BIT(6) : BIT(7);
}

static esp_err_t led_strip_spi_set_pixel(led_strip_t *strip, uint32_t index, uint32_t red, uint32_t green, uint32_t blue)
{
    led_strip_spi_obj *spi_strip = __containerof(strip, led_strip_spi_obj, base);
    ESP_RETURN_ON_FALSE(index &lt; spi_strip-&gt;strip_len, ESP_ERR_INVALID_ARG, TAG, &quot;index out of maximum number of LEDs&quot;);
    // 3 pixels take 72bits(9bytes)
    uint32_t start = index * spi_strip-&gt;bytes_per_pixel * SPI_BYTES_PER_COLOR_BYTE;
    uint8_t *pixel_buf = spi_strip-&gt;pixel_buf;
    struct format_layout format = spi_strip-&gt;component_fmt.format;
    memset(pixel_buf + start, 0, spi_strip-&gt;bytes_per_pixel * SPI_BYTES_PER_COLOR_BYTE);

    uint8_t pos_bytes = format.bytes_per_color;
    for (uint8_t i = 0; i &lt; format.bytes_per_color; i++) {
        uint8_t color_shift = 8 * (format.bytes_per_color - 1 - i);
        __led_strip_spi_bit((red &gt;&gt; color_shift) &amp; 0xFF, &amp;pixel_buf[start + SPI_BYTES_PER_COLOR_BYTE * (format.r_pos * pos_bytes + i)]);
        __led_strip_spi_bit((green &gt;&gt; color_shift) &amp; 0xFF, &amp;pixel_buf[start + SPI_BYTES_PER_COLOR_BYTE * (format.g_pos * pos_bytes + i)]);
        __led_strip_spi_bit((blue &gt;&gt; color_shift) &amp; 0xFF, &amp;pixel_buf[start + SPI_BYTES_PER_COLOR_BYTE * (format.b_pos * pos_bytes + i)]);
        if (format.num_components &gt; 3) {
            __led_strip_spi_bit(0, &amp;pixel_buf[start + SPI_BYTES_PER_COLOR_BYTE * (format.w_pos * pos_bytes + i)]);
        }
    }
    return ESP_OK;
}

static esp_err_t led_strip_spi_set_pixel_rgbw(led_strip_t *strip, uint32_t index, uint32_t red, uint32_t green, uint32_t blue, uint32_t white)
{
    led_strip_spi_obj *spi_strip = __containerof(strip, led_strip_spi_obj, base);
    struct format_layout format = spi_strip-&gt;component_fmt.format;
    ESP_RETURN_ON_FALSE(index &lt; spi_strip-&gt;strip_len, ESP_ERR_INVALID_ARG, TAG, &quot;index out of maximum number of LEDs&quot;);
    ESP_RETURN_ON_FALSE(format.num_components == 4, ESP_ERR_INVALID_ARG, TAG, &quot;led doesn't have 4 components&quot;);

    // LED_PIXEL_FORMAT_GRBW takes 96bits(12bytes)
    uint32_t start = index * spi_strip-&gt;bytes_per_pixel * SPI_BYTES_PER_COLOR_BYTE;
    uint8_t *pixel_buf = spi_strip-&gt;pixel_buf;
    memset(pixel_buf + start, 0, spi_strip-&gt;bytes_per_pixel * SPI_BYTES_PER_COLOR_BYTE);

    uint8_t pos_bytes = format.bytes_per_color;
    for (uint8_t i = 0; i &lt; format.bytes_per_color; i++) {
        uint8_t color_shift = 8 * (format.bytes_per_color - 1 - i);
        __led_strip_spi_bit((red &gt;&gt; color_shift) &amp; 0xFF, &amp;pixel_buf[start + SPI_BYTES_PER_COLOR_BYTE * (format.r_pos * pos_bytes + i)]);
        __led_strip_spi_bit((green &gt;&gt; color_shift) &amp; 0xFF, &amp;pixel_buf[start + SPI_BYTES_PER_COLOR_BYTE * (format.g_pos * pos_bytes + i)]);
        __led_strip_spi_bit((blue &gt;&gt; color_shift) &amp; 0xFF, &amp;pixel_buf[start + SPI_BYTES_PER_COLOR_BYTE * (format.b_pos * pos_bytes + i)]);
        __led_strip_spi_bit((white &gt;&gt; color_shift) &amp; 0xFF, &amp;pixel_buf[start + SPI_BYTES_PER_COLOR_BYTE * (format.w_pos * pos_bytes + i)]);
    }
    return ESP_OK;
}

static esp_err_t led_strip_spi_refresh(led_strip_t *strip)
{
    led_strip_spi_obj *spi_strip = __containerof(strip, led_strip_spi_obj, base);
    spi_transaction_t tx_conf;
    memset(&amp;tx_conf, 0, sizeof(tx_conf));

    tx_conf.length = spi_strip-&gt;strip_len * spi_strip-&gt;bytes_per_pixel * SPI_BITS_PER_COLOR_BYTE;
    tx_conf.tx_buffer = spi_strip-&gt;pixel_buf;
    tx_conf.rx_buffer = NULL;
    ESP_RETURN_ON_ERROR(spi_device_transmit(spi_strip-&gt;spi_device, &amp;tx_conf), TAG, &quot;transmit pixels by SPI failed&quot;);

    return ESP_OK;
}

static esp_err_t led_strip_spi_clear(led_strip_t *strip)
{
    led_strip_spi_obj *spi_strip = __containerof(strip, led_strip_spi_obj, base);
    //Write zero to turn off all leds
    memset(spi_strip-&gt;pixel_buf, 0, spi_strip-&gt;strip_len * spi_strip-&gt;bytes_per_pixel * SPI_BYTES_PER_COLOR_BYTE);
    uint8_t *buf = spi_strip-&gt;pixel_buf;
    for (int index = 0; index &lt; spi_strip-&gt;strip_len * spi_strip-&gt;bytes_per_pixel; index++) {
        __led_strip_spi_bit(0, buf);
        buf += SPI_BYTES_PER_COLOR_BYTE;
    }

    return led_strip_spi_refresh(strip);
}

static esp_err_t led_strip_spi_del(led_strip_t *strip)
{
    led_strip_spi_obj *spi_strip = __containerof(strip, led_strip_spi_obj, base);

    ESP_RETURN_ON_ERROR(spi_bus_remove_device(spi_strip-&gt;spi_device), TAG, &quot;delete spi device failed&quot;);
    ESP_RETURN_ON_ERROR(spi_bus_free(spi_strip-&gt;spi_host), TAG, &quot;free spi bus failed&quot;);

    free(spi_strip);
    return ESP_OK;
}

esp_err_t led_strip_new_spi_device(const led_strip_config_t *led_config, const led_strip_spi_config_t *spi_config, led_strip_handle_t *ret_strip)
{
    led_strip_spi_obj *spi_strip = NULL;
    esp_err_t ret = ESP_OK;
    ESP_GOTO_ON_FALSE(led_config &amp;&amp; spi_config &amp;&amp; ret_strip, ESP_ERR_INVALID_ARG, err, TAG, &quot;invalid argument&quot;);
    led_color_component_format_t component_fmt = led_config-&gt;color_component_format;
    // If R/G/B order is not specified, set default GRB order as fallback
    if (component_fmt.format_id == 0) {
        component_fmt = LED_STRIP_COLOR_COMPONENT_FMT_GRB;
    }
    if (led_config-&gt;led_model == LED_MODEL_WS2816) {
        component_fmt.format.bytes_per_color = 2;
    }
    if (component_fmt.format.bytes_per_color == 0) {
        component_fmt.format.bytes_per_color = 1;
    }
    uint8_t mask = 0;
    if (component_fmt.format.num_components == 3) {
        mask = BIT(component_fmt.format.r_pos) | BIT(component_fmt.format.g_pos) | BIT(component_fmt.format.b_pos);
        // Check for invalid values
        ESP_RETURN_ON_FALSE(mask == 0x07, ESP_ERR_INVALID_ARG, TAG, &quot;invalid order argument&quot;);
    } else if (component_fmt.format.num_components == 4) {
        mask = BIT(component_fmt.format.r_pos) | BIT(component_fmt.format.g_pos) | BIT(component_fmt.format.b_pos) | BIT(component_fmt.format.w_pos);
        // Check for invalid values
        ESP_RETURN_ON_FALSE(mask == 0x0F, ESP_ERR_INVALID_ARG, TAG, &quot;invalid order argument&quot;);
    } else {
        ESP_RETURN_ON_FALSE(false, ESP_ERR_INVALID_ARG, TAG, &quot;invalid number of color components: %d&quot;, component_fmt.format.num_components);
    }
    uint8_t bytes_per_pixel = component_fmt.format.num_components;
    if (component_fmt.format.bytes_per_color &gt; 1) {
        bytes_per_pixel *= component_fmt.format.bytes_per_color;
    }
    uint32_t mem_caps = MALLOC_CAP_DEFAULT;
    if (spi_config-&gt;flags.with_dma) {
        // DMA buffer must be placed in internal SRAM
        mem_caps |= MALLOC_CAP_INTERNAL | MALLOC_CAP_DMA;
    }
    spi_strip = heap_caps_calloc(1, sizeof(led_strip_spi_obj) + led_config-&gt;max_leds * bytes_per_pixel * SPI_BYTES_PER_COLOR_BYTE, mem_caps);

    ESP_GOTO_ON_FALSE(spi_strip, ESP_ERR_NO_MEM, err, TAG, &quot;no mem for spi strip&quot;);

    spi_strip-&gt;spi_host = spi_config-&gt;spi_bus;
    // for backward compatibility, if the user does not set the clk_src, use the default value
    spi_clock_source_t clk_src = SPI_CLK_SRC_DEFAULT;
    if (spi_config-&gt;clk_src) {
        clk_src = spi_config-&gt;clk_src;
    }

    spi_bus_config_t spi_bus_cfg = {
        .mosi_io_num = led_config-&gt;strip_gpio_num,
        //Only use MOSI to generate the signal, set -1 when other pins are not used.
        .miso_io_num = -1,
        .sclk_io_num = -1,
        .quadwp_io_num = -1,
        .quadhd_io_num = -1,
        .max_transfer_sz = led_config-&gt;max_leds * bytes_per_pixel * SPI_BYTES_PER_COLOR_BYTE,
    };
    ESP_GOTO_ON_ERROR(spi_bus_initialize(spi_strip-&gt;spi_host, &amp;spi_bus_cfg, spi_config-&gt;flags.with_dma ? SPI_DMA_CH_AUTO : SPI_DMA_DISABLED), err, TAG, &quot;create SPI bus failed&quot;);

    if (led_config-&gt;flags.invert_out == true) {
        esp_rom_gpio_connect_out_signal(led_config-&gt;strip_gpio_num, spi_periph_signal[spi_strip-&gt;spi_host].spid_out, true, false);
    }

    spi_device_interface_config_t spi_dev_cfg = {
        .clock_source = clk_src,
        .command_bits = 0,
        .address_bits = 0,
        .dummy_bits = 0,
        .clock_speed_hz = LED_STRIP_SPI_DEFAULT_RESOLUTION,
        .mode = 0,
        //set -1 when CS is not used
        .spics_io_num = -1,
        .queue_size = LED_STRIP_SPI_DEFAULT_TRANS_QUEUE_SIZE,
    };

    ESP_GOTO_ON_ERROR(spi_bus_add_device(spi_strip-&gt;spi_host, &amp;spi_dev_cfg, &amp;spi_strip-&gt;spi_device), err, TAG, &quot;Failed to add spi device&quot;);
    //ensure the reset time is enough
    esp_rom_delay_us(10);
    int clock_resolution_khz = 0;
    spi_device_get_actual_freq(spi_strip-&gt;spi_device, &amp;clock_resolution_khz);
    // TODO: ideally we should decide the SPI_BYTES_PER_COLOR_BYTE by the real clock resolution
    // But now, let's fixed the resolution, the downside is, we don't support a clock source whose frequency is not multiple of LED_STRIP_SPI_DEFAULT_RESOLUTION
    // clock_resolution between 2.2MHz to 2.8MHz is supported
    ESP_GOTO_ON_FALSE((clock_resolution_khz &lt; LED_STRIP_SPI_DEFAULT_RESOLUTION / 1000 + 300) &amp;&amp; (clock_resolution_khz &gt; LED_STRIP_SPI_DEFAULT_RESOLUTION / 1000 - 300), ESP_ERR_NOT_SUPPORTED, err,
                      TAG, &quot;unsupported clock resolution:%dKHz&quot;, clock_resolution_khz);

    if (led_config-&gt;led_model != LED_MODEL_WS2812) {
        ESP_LOGW(TAG, &quot;Only support WS2812. The timing requirements for other models may not be met&quot;);
    }

    spi_strip-&gt;component_fmt = component_fmt;
    spi_strip-&gt;bytes_per_pixel = bytes_per_pixel;
    spi_strip-&gt;strip_len = led_config-&gt;max_leds;
    spi_strip-&gt;base.set_pixel = led_strip_spi_set_pixel;
    spi_strip-&gt;base.set_pixel_rgbw = led_strip_spi_set_pixel_rgbw;
    spi_strip-&gt;base.refresh = led_strip_spi_refresh;
    spi_strip-&gt;base.clear = led_strip_spi_clear;
    spi_strip-&gt;base.del = led_strip_spi_del;

    *ret_strip = &amp;spi_strip-&gt;base;
    return ESP_OK;
err:
    if (spi_strip) {
        if (spi_strip-&gt;spi_device) {
            spi_bus_remove_device(spi_strip-&gt;spi_device);
        }
        if (spi_strip-&gt;spi_host) {
            spi_bus_free(spi_strip-&gt;spi_host);
        }
        free(spi_strip);
    }
    return ret;
}
</code></pre>
              
            </div>
          </div><footer>

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
          
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
        <span>
          <a href="https://github.com/Awul/SWAN-MODULE" class="fa fa-code-fork" style="color: #fcfcfc"> Awul/SWAN-MODULE</a>
        </span>
    
    
    
  </span>
</div>
    <script src="../../js/jquery-3.6.0.min.js"></script>
    <script>var base_url = "../..";</script>
    <script src="../../js/theme_extra.js"></script>
    <script src="../../js/theme.js"></script>
      <script src="../../search/main.js"></script>
    <script>
        jQuery(function () {
            SphinxRtdTheme.Navigation.enable(true);
        });
    </script>

</body>
</html>
