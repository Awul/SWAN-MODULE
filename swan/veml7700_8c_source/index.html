<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="author" content="SWAN Team" />
      <link rel="shortcut icon" href="../../img/favicon.ico" />
    <title>File veml7700.c - SWAN Module Documentation</title>
    <link rel="stylesheet" href="../../css/theme.css" />
    <link rel="stylesheet" href="../../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "File veml7700.c";
        var mkdocs_page_input_path = "swan\\veml7700_8c_source.md";
        var mkdocs_page_url = null;
      </script>
    
    <!--[if lt IE 9]>
      <script src="../../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
      <script>hljs.highlightAll();</script> 
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href="../.." class="icon icon-home"> SWAN Module Documentation
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../..">Home</a>
                </li>
              </ul>
              <p class="caption"><span class="caption-text">Getting Started</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../getting-started/overview/">Overview</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../getting-started/build/">Build & Flash</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">API Reference</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../">Overview</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../modules/">Modules</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Guides</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../guides/architecture/">Architecture</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../guides/style/">Coding Style</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">About</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../about/license/">License</a>
                  </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../..">SWAN Module Documentation</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../.." class="icon icon-home" aria-label="Docs"></a></li>
      <li class="breadcrumb-item active">File veml7700.c</li>
    <li class="wy-breadcrumbs-aside">
          <a href="https://github.com/Awul/SWAN-MODULE/edit/master/docs/swan/veml7700_8c_source.md">Edit on Awul/SWAN-MODULE</a>
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="file-veml7700c">File veml7700.c</h1>
<p><a href="../files/"><strong>File List</strong></a> <strong>&gt;</strong> <a href="../dir_409f97388efe006bc3438b95e9edef48/"><strong>components</strong></a> <strong>&gt;</strong> <a href="../dir_0150b187d0697ce476d48596f0c108de/"><strong>veml7700</strong></a> <strong>&gt;</strong> <a href="../veml7700_8c/"><strong>veml7700.c</strong></a></p>
<p><a href="../veml7700_8c/">Go to the documentation of this file</a></p>
<pre><code class="language-C++">

#include &quot;veml7700.h&quot;



static esp_err_t veml7700_write16(const veml7700_t *dev, uint8_t reg, uint16_t val)
{
    uint8_t data[3] = {
        reg,
        val &amp; 0xFF,
        val &gt;&gt; 8
    };

    return i2c_master_write_to_device(
        dev-&gt;i2c_port,
        dev-&gt;i2c_addr,
        data,
        sizeof(data),
        pdMS_TO_TICKS(100)
    );
}

static esp_err_t veml7700_read16(const veml7700_t *dev, uint8_t reg, uint16_t *val)
{
    uint8_t data[2];

    esp_err_t err = i2c_master_write_read_device(
        dev-&gt;i2c_port,
        dev-&gt;i2c_addr,
        &amp;reg,
        1,
        data,
        sizeof(data),
        pdMS_TO_TICKS(100)
    );

    if (err == ESP_OK) {
        *val = data[0] | (data[1] &lt;&lt; 8);
    }

    return err;
}

void veml7700_print_registers(const veml7700_t *dev)
{
    // The registers are all 16-bit
    uint16_t r[8];

    for (uint8_t i = 0; i &lt;= 7; i++) {
        if (veml7700_read16(dev, i, &amp;r[i]) != ESP_OK) {
            ESP_LOGE(&quot;VEML7700&quot;, &quot;Failed to read register 0x%02X&quot;, i);
            return;
        }
    }

    ESP_LOGI(&quot;VEML7700&quot;, &quot;========== VEML7700 REGISTER DUMP ==========&quot;);
    ESP_LOGI(&quot;VEML7700&quot;, &quot;ALS_CONF_0 (0x00): 0x%04X&quot;,   r[0]);
    ESP_LOGI(&quot;VEML7700&quot;, &quot;ALS_WH     (0x01): %u&quot;,       r[1]);
    ESP_LOGI(&quot;VEML7700&quot;, &quot;ALS_WL     (0x02): %u&quot;,       r[2]);
    ESP_LOGI(&quot;VEML7700&quot;, &quot;POWER_SAVE (0x03): 0x%04X&quot;,   r[3]);
    ESP_LOGI(&quot;VEML7700&quot;, &quot;ALS        (0x04): %u&quot;,       r[4]);
    ESP_LOGI(&quot;VEML7700&quot;, &quot;WHITE      (0x05): %u&quot;,       r[5]);
    ESP_LOGI(&quot;VEML7700&quot;, &quot;ALS_INT    (0x06): 0x%04X&quot;,   r[6]);
    ESP_LOGI(&quot;VEML7700&quot;, &quot;ID         (0x07): 0x%04X&quot;,   r[7]);

    /* ---------- Interpret configuration ---------- */
    uint16_t conf = r[0];

    // Decode the bit fields
    // 0x01 = 0b1, 0x03 = 0b11, 0x0F = 0b1111 -&gt; bit masking
    // Shift right to align the field, then mask to extract the value
    uint8_t gain = (conf &gt;&gt; 11) &amp; 0x03;
    uint8_t it   = (conf &gt;&gt; 6)  &amp; 0x0F;
    uint8_t pers = (conf &gt;&gt; 4)  &amp; 0x03;
    bool int_en  = (conf &gt;&gt; 1)  &amp; 0x01;
    bool shutdown = conf &amp; 0x01;

    // Based on the datasheet, these are the possible gain and integration time settings
    //TODO: Can use the new helper functions to calculate responsivity and gain factor instead of hardcoding the strings here
    const char *gain_str[] = {
        &quot;x1&quot;, &quot;x2&quot;, &quot;x1/8&quot;, &quot;x1/4&quot;
    };

    char *it_str = &quot;UNKNOWN&quot;;
    switch (it) {
        case 0x0: it_str = &quot;100 ms&quot;; break;
        case 0x1: it_str = &quot;200 ms&quot;; break;
        case 0x2: it_str = &quot;400 ms&quot;; break;
        case 0x3: it_str = &quot;800 ms&quot;; break;
        case 0x8: it_str = &quot;50 ms&quot;;  break;
        case 0xC: it_str = &quot;25 ms&quot;;  break;
    }

    ESP_LOGI(&quot;VEML7700&quot;, &quot;---------- Configuration ----------&quot;);
    ESP_LOGI(&quot;VEML7700&quot;, &quot;ALS Gain           : %s&quot;, gain_str[gain]);
    ESP_LOGI(&quot;VEML7700&quot;, &quot;Integration Time   : %s&quot;, it_str);
    ESP_LOGI(&quot;VEML7700&quot;, &quot;Persistence        : %u sample(s)&quot;, 1 &lt;&lt; pers);
    ESP_LOGI(&quot;VEML7700&quot;, &quot;Interrupt Enabled  : %s&quot;, int_en ? &quot;YES&quot; : &quot;NO&quot;);
    ESP_LOGI(&quot;VEML7700&quot;, &quot;Sensor State       : %s&quot;, shutdown ? &quot;SHUTDOWN&quot; : &quot;ACTIVE&quot;);

    /* ---------- Power saving ---------- */
    uint8_t psm = (r[3] &gt;&gt; 1) &amp; 0x03;
    bool psm_en = r[3] &amp; 0x01;

    ESP_LOGI(&quot;VEML7700&quot;, &quot;---------- Power Saving ----------&quot;);
    ESP_LOGI(&quot;VEML7700&quot;, &quot;PSM Enabled        : %s&quot;, psm_en ? &quot;YES&quot; : &quot;NO&quot;);
    ESP_LOGI(&quot;VEML7700&quot;, &quot;PSM Mode           : %u&quot;, psm + 1);

    /* ---------- Interrupt status ---------- */
    ESP_LOGI(&quot;VEML7700&quot;, &quot;---------- Interrupt Status ----------&quot;);
    ESP_LOGI(&quot;VEML7700&quot;, &quot;Low Threshold Hit  : %s&quot;, (r[6] &amp; (1 &lt;&lt; 15)) ? &quot;YES&quot; : &quot;NO&quot;);
    ESP_LOGI(&quot;VEML7700&quot;, &quot;High Threshold Hit : %s&quot;, (r[6] &amp; (1 &lt;&lt; 14)) ? &quot;YES&quot; : &quot;NO&quot;);

    /* ---------- ID decoding ---------- */
    uint8_t id_lsb = r[7] &amp; 0xFF;
    uint8_t id_msb = r[7] &gt;&gt; 8;

    ESP_LOGI(&quot;VEML7700&quot;, &quot;---------- Device ID ----------&quot;);
    ESP_LOGI(&quot;VEML7700&quot;, &quot;Device ID Code     : 0x%02X (%s)&quot;,
             id_lsb, (id_lsb == 0x81) ? &quot;VALID&quot; : &quot;UNKNOWN&quot;);

    ESP_LOGI(&quot;VEML7700&quot;, &quot;Address Option     : 0x%02X&quot;, id_msb);
    ESP_LOGI(&quot;VEML7700&quot;, &quot;==========================================&quot;);
}

esp_err_t veml7700_init(veml7700_t *dev, i2c_port_t port)
{
    if (!dev) {
        return ESP_ERR_INVALID_ARG;
    }

    dev-&gt;i2c_port = port;
    dev-&gt;i2c_addr = VEML7700_I2C_ADDR_DEFAULT;

    /* Power on the sensor */
    ESP_ERROR_CHECK(veml7700_write16(dev, VEML7700_REG_POWER_SAVING, 0x0000));

    /* Default ALS configuration:
     * Gain = 1Ã—
     * Integration time = 100 ms
     * ALS enabled
     */
    ESP_ERROR_CHECK(veml7700_write16(dev, VEML7700_REG_ALS_CONF_0, 0x0000));

    vTaskDelay(pdMS_TO_TICKS(10));
    return ESP_OK;
}

esp_err_t veml7700_read_als(veml7700_t *dev, uint16_t *als)
{
    if (!dev || !als) {
        return ESP_ERR_INVALID_ARG;
    }

    // The ALS register is 16-bit, so we can use the read16 helper function
    // This reads the ALS but not the WHITE channel. The white channel can be read separately if needed.
    return veml7700_read16(dev, VEML7700_REG_ALS, als);
}

float veml7700_responsivity(uint8_t it_bits) {
    switch (it_bits) {
        case 0b1100: return 0.2304f; // 25 ms
        case 0b1000: return 0.1152f; // 50 ms
        case 0b0000: return 0.0576f; // 100 ms
        case 0b0001: return 0.0288f; // 200 ms
        case 0b0010: return 0.0144f; // 400 ms
        case 0b0011: return 0.0072f; // 800 ms
    }
    return 0.0576f; // fallback 100 ms
}

float veml7700_gain_factor(uint8_t gain_bits) {
    switch (gain_bits) {
        case 0b00: return 1.0f;   // x1
        case 0b01: return 2.0f;   // x2
        case 0b10: return 0.125f; // x1/8
        case 0b11: return 0.25f;  // x1/4
    }
    return 1.0f; // fallback
}

esp_err_t veml7700_read_lux(veml7700_t *dev, float *lux)
{
    if (!dev || !lux) {
        return ESP_ERR_INVALID_ARG;
    }

    uint16_t als_conf, als_data;
    esp_err_t ret;

    //read ALS_CONF_0
    ret = veml7700_read16(dev, VEML7700_REG_ALS_CONF_0, &amp;als_conf);
    if (ret != ESP_OK) return ret;

    //read ALS data
    ret = veml7700_read_als(dev, &amp;als_data);
    if (ret != ESP_OK) return ret;

    // Extract gain and integration time settings from the configuration register
    uint8_t gain_bits = (als_conf &gt;&gt; 11) &amp; 0x03;
    uint8_t it_bits   = (als_conf &gt;&gt; 6)  &amp; 0x0F;

    //Lookup gain factor and responsivity
    float gain_factor = veml7700_gain_factor(gain_bits);
    float responsivity = veml7700_responsivity(it_bits);

    // Conversion of als_data to lux
    *lux = als_data / gain_factor * responsivity;
    return ESP_OK;
}
</code></pre>
              
            </div>
          </div><footer>

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
          
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
        <span>
          <a href="https://github.com/Awul/SWAN-MODULE" class="fa fa-code-fork" style="color: #fcfcfc"> Awul/SWAN-MODULE</a>
        </span>
    
    
    
  </span>
</div>
    <script src="../../js/jquery-3.6.0.min.js"></script>
    <script>var base_url = "../..";</script>
    <script src="../../js/theme_extra.js"></script>
    <script src="../../js/theme.js"></script>
      <script src="../../search/main.js"></script>
    <script>
        jQuery(function () {
            SphinxRtdTheme.Navigation.enable(true);
        });
    </script>

</body>
</html>
