<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="author" content="SWAN Team" />
      <link rel="shortcut icon" href="../../img/favicon.ico" />
    <title>File led_strip_rmt_dev.c - SWAN Module Documentation</title>
    <link rel="stylesheet" href="../../css/theme.css" />
    <link rel="stylesheet" href="../../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "File led_strip_rmt_dev.c";
        var mkdocs_page_input_path = "swan\\led__strip__rmt__dev_8c_source.md";
        var mkdocs_page_url = null;
      </script>
    
    <!--[if lt IE 9]>
      <script src="../../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
      <script>hljs.highlightAll();</script> 
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href="../.." class="icon icon-home"> SWAN Module Documentation
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../..">Home</a>
                </li>
              </ul>
              <p class="caption"><span class="caption-text">Getting Started</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../getting-started/overview/">Overview</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../getting-started/build/">Build & Flash</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">API Reference</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../">Overview</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../modules/">Modules</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Guides</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../guides/architecture/">Architecture</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../guides/style/">Coding Style</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">About</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../about/license/">License</a>
                  </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../..">SWAN Module Documentation</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../.." class="icon icon-home" aria-label="Docs"></a></li>
      <li class="breadcrumb-item active">File led_strip_rmt_dev.c</li>
    <li class="wy-breadcrumbs-aside">
          <a href="https://github.com/Awul/SWAN-MODULE/edit/master/docs/swan/led__strip__rmt__dev_8c_source.md">Edit on Awul/SWAN-MODULE</a>
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="file-led_strip_rmt_devc">File led_strip_rmt_dev.c</h1>
<p><a href="../files/"><strong>File List</strong></a> <strong>&gt;</strong> <a href="../dir_ed75a055ae422585327f9cac7433a4c6/"><strong>blink</strong></a> <strong>&gt;</strong> <a href="../dir_f14b78939adc8414aa21d6af988468d0/"><strong>managed_components</strong></a> <strong>&gt;</strong> <a href="../dir_d0251c514b1be4d4f41659a309ca9490/"><strong>espressif__led_strip</strong></a> <strong>&gt;</strong> <a href="../dir_163002825b6da09af3d0cb3d07e787f0/"><strong>src</strong></a> <strong>&gt;</strong> <a href="../led__strip__rmt__dev_8c/"><strong>led_strip_rmt_dev.c</strong></a></p>
<p><a href="../led__strip__rmt__dev_8c/">Go to the documentation of this file</a></p>
<pre><code class="language-C++">/*
 * SPDX-FileCopyrightText: 2022-2024 Espressif Systems (Shanghai) CO LTD
 *
 * SPDX-License-Identifier: Apache-2.0
 */
#include &lt;stdlib.h&gt;
#include &lt;string.h&gt;
#include &lt;sys/cdefs.h&gt;
#include &quot;esp_log.h&quot;
#include &quot;esp_check.h&quot;
#include &quot;driver/rmt_tx.h&quot;
#include &quot;led_strip.h&quot;
#include &quot;led_strip_interface.h&quot;
#include &quot;led_strip_rmt_encoder.h&quot;

#define LED_STRIP_RMT_DEFAULT_RESOLUTION 10000000 // 10MHz resolution
#define LED_STRIP_RMT_DEFAULT_TRANS_QUEUE_SIZE 4
// the memory size of each RMT channel, in words (4 bytes)
#if CONFIG_IDF_TARGET_ESP32 || CONFIG_IDF_TARGET_ESP32S2
#define LED_STRIP_RMT_DEFAULT_MEM_BLOCK_SYMBOLS 64
#else
#define LED_STRIP_RMT_DEFAULT_MEM_BLOCK_SYMBOLS 48
#endif

static const char *TAG = &quot;led_strip_rmt&quot;;

typedef struct {
    led_strip_t base;
    rmt_channel_handle_t rmt_chan;
    rmt_encoder_handle_t strip_encoder;
    uint32_t strip_len;
    uint8_t bytes_per_pixel;
    led_color_component_format_t component_fmt;
    uint8_t pixel_buf[];
} led_strip_rmt_obj;

static esp_err_t led_strip_rmt_set_pixel(led_strip_t *strip, uint32_t index, uint32_t red, uint32_t green, uint32_t blue)
{
    led_strip_rmt_obj *rmt_strip = __containerof(strip, led_strip_rmt_obj, base);
    ESP_RETURN_ON_FALSE(index &lt; rmt_strip-&gt;strip_len, ESP_ERR_INVALID_ARG, TAG, &quot;index out of maximum number of LEDs&quot;);

    struct format_layout format = rmt_strip-&gt;component_fmt.format;
    uint32_t start = index * rmt_strip-&gt;bytes_per_pixel;
    uint8_t *pixel_buf = rmt_strip-&gt;pixel_buf;
    uint8_t pos_bytes = format.bytes_per_color;

    for (uint8_t i = 0; i &lt; format.bytes_per_color; i++) {
        uint8_t color_shift = 8 * (format.bytes_per_color - 1 - i);
        pixel_buf[start + format.r_pos * pos_bytes + i] = (red &gt;&gt; color_shift) &amp; 0xFF;
        pixel_buf[start + format.g_pos * pos_bytes + i] = (green &gt;&gt; color_shift) &amp; 0xFF;
        pixel_buf[start + format.b_pos * pos_bytes + i] = (blue &gt;&gt; color_shift) &amp; 0xFF;
        if (format.num_components &gt; 3) {
            pixel_buf[start + format.w_pos * pos_bytes + i] = 0;
        }
    }
    return ESP_OK;
}

static esp_err_t led_strip_rmt_set_pixel_rgbw(led_strip_t *strip, uint32_t index, uint32_t red, uint32_t green, uint32_t blue, uint32_t white)
{
    led_strip_rmt_obj *rmt_strip = __containerof(strip, led_strip_rmt_obj, base);
    struct format_layout format = rmt_strip-&gt;component_fmt.format;
    ESP_RETURN_ON_FALSE(index &lt; rmt_strip-&gt;strip_len, ESP_ERR_INVALID_ARG, TAG, &quot;index out of maximum number of LEDs&quot;);
    ESP_RETURN_ON_FALSE(format.num_components == 4, ESP_ERR_INVALID_ARG, TAG, &quot;led doesn't have 4 components&quot;);

    uint32_t start = index * rmt_strip-&gt;bytes_per_pixel;
    uint8_t *pixel_buf = rmt_strip-&gt;pixel_buf;
    uint8_t pos_bytes = format.bytes_per_color;

    for (uint8_t i = 0; i &lt; format.bytes_per_color; i++) {
        uint8_t color_shift = 8 * (format.bytes_per_color - 1 - i);
        pixel_buf[start + format.r_pos * pos_bytes + i] = (red &gt;&gt; color_shift) &amp; 0xFF;
        pixel_buf[start + format.g_pos * pos_bytes + i] = (green &gt;&gt; color_shift) &amp; 0xFF;
        pixel_buf[start + format.b_pos * pos_bytes + i] = (blue &gt;&gt; color_shift) &amp; 0xFF;
        pixel_buf[start + format.w_pos * pos_bytes + i] = (white &gt;&gt; color_shift) &amp; 0xFF;
    }
    return ESP_OK;
}

static esp_err_t led_strip_rmt_refresh(led_strip_t *strip)
{
    led_strip_rmt_obj *rmt_strip = __containerof(strip, led_strip_rmt_obj, base);
    rmt_transmit_config_t tx_conf = {
        .loop_count = 0,
    };

    ESP_RETURN_ON_ERROR(rmt_enable(rmt_strip-&gt;rmt_chan), TAG, &quot;enable RMT channel failed&quot;);
    ESP_RETURN_ON_ERROR(rmt_transmit(rmt_strip-&gt;rmt_chan, rmt_strip-&gt;strip_encoder, rmt_strip-&gt;pixel_buf,
                                     rmt_strip-&gt;strip_len * rmt_strip-&gt;bytes_per_pixel, &amp;tx_conf), TAG, &quot;transmit pixels by RMT failed&quot;);
    ESP_RETURN_ON_ERROR(rmt_tx_wait_all_done(rmt_strip-&gt;rmt_chan, -1), TAG, &quot;flush RMT channel failed&quot;);
    ESP_RETURN_ON_ERROR(rmt_disable(rmt_strip-&gt;rmt_chan), TAG, &quot;disable RMT channel failed&quot;);
    return ESP_OK;
}

static esp_err_t led_strip_rmt_clear(led_strip_t *strip)
{
    led_strip_rmt_obj *rmt_strip = __containerof(strip, led_strip_rmt_obj, base);
    // Write zero to turn off all leds
    memset(rmt_strip-&gt;pixel_buf, 0, rmt_strip-&gt;strip_len * rmt_strip-&gt;bytes_per_pixel);
    return led_strip_rmt_refresh(strip);
}

static esp_err_t led_strip_rmt_del(led_strip_t *strip)
{
    led_strip_rmt_obj *rmt_strip = __containerof(strip, led_strip_rmt_obj, base);
    ESP_RETURN_ON_ERROR(rmt_del_channel(rmt_strip-&gt;rmt_chan), TAG, &quot;delete RMT channel failed&quot;);
    ESP_RETURN_ON_ERROR(rmt_del_encoder(rmt_strip-&gt;strip_encoder), TAG, &quot;delete strip encoder failed&quot;);
    free(rmt_strip);
    return ESP_OK;
}

esp_err_t led_strip_new_rmt_device(const led_strip_config_t *led_config, const led_strip_rmt_config_t *rmt_config, led_strip_handle_t *ret_strip)
{
    led_strip_rmt_obj *rmt_strip = NULL;
    esp_err_t ret = ESP_OK;
    ESP_GOTO_ON_FALSE(led_config &amp;&amp; rmt_config &amp;&amp; ret_strip, ESP_ERR_INVALID_ARG, err, TAG, &quot;invalid argument&quot;);
    led_color_component_format_t component_fmt = led_config-&gt;color_component_format;
    // If R/G/B order is not specified, set default GRB order as fallback
    if (component_fmt.format_id == 0) {
        component_fmt = LED_STRIP_COLOR_COMPONENT_FMT_GRB;
    }
    if (led_config-&gt;led_model == LED_MODEL_WS2816) {
        component_fmt.format.bytes_per_color = 2;
    }
    if (component_fmt.format.bytes_per_color == 0) {
        component_fmt.format.bytes_per_color = 1;
    }
    // check the validation of the color component format
    uint8_t mask = 0;
    if (component_fmt.format.num_components == 3) {
        mask = BIT(component_fmt.format.r_pos) | BIT(component_fmt.format.g_pos) | BIT(component_fmt.format.b_pos);
        // Check for invalid values
        ESP_RETURN_ON_FALSE(mask == 0x07, ESP_ERR_INVALID_ARG, TAG, &quot;invalid order argument&quot;);
    } else if (component_fmt.format.num_components == 4) {
        mask = BIT(component_fmt.format.r_pos) | BIT(component_fmt.format.g_pos) | BIT(component_fmt.format.b_pos) | BIT(component_fmt.format.w_pos);
        // Check for invalid values
        ESP_RETURN_ON_FALSE(mask == 0x0F, ESP_ERR_INVALID_ARG, TAG, &quot;invalid order argument&quot;);
    } else {
        ESP_RETURN_ON_FALSE(false, ESP_ERR_INVALID_ARG, TAG, &quot;invalid number of color components: %d&quot;, component_fmt.format.num_components);
    }
    uint8_t bytes_per_pixel = component_fmt.format.num_components;
    if (component_fmt.format.bytes_per_color &gt; 1) {
        bytes_per_pixel *= component_fmt.format.bytes_per_color;
    }
    rmt_strip = calloc(1, sizeof(led_strip_rmt_obj) + led_config-&gt;max_leds * bytes_per_pixel);
    ESP_GOTO_ON_FALSE(rmt_strip, ESP_ERR_NO_MEM, err, TAG, &quot;no mem for rmt strip&quot;);
    uint32_t resolution = rmt_config-&gt;resolution_hz ? rmt_config-&gt;resolution_hz : LED_STRIP_RMT_DEFAULT_RESOLUTION;

    // for backward compatibility, if the user does not set the clk_src, use the default value
    rmt_clock_source_t clk_src = RMT_CLK_SRC_DEFAULT;
    if (rmt_config-&gt;clk_src) {
        clk_src = rmt_config-&gt;clk_src;
    }
    size_t mem_block_symbols = LED_STRIP_RMT_DEFAULT_MEM_BLOCK_SYMBOLS;
    // override the default value if the user sets it
    if (rmt_config-&gt;mem_block_symbols) {
        mem_block_symbols = rmt_config-&gt;mem_block_symbols;
    }
    rmt_tx_channel_config_t rmt_chan_config = {
        .clk_src = clk_src,
        .gpio_num = led_config-&gt;strip_gpio_num,
        .mem_block_symbols = mem_block_symbols,
        .resolution_hz = resolution,
        .trans_queue_depth = LED_STRIP_RMT_DEFAULT_TRANS_QUEUE_SIZE,
        .flags.with_dma = rmt_config-&gt;flags.with_dma,
        .flags.invert_out = led_config-&gt;flags.invert_out,
    };
    ESP_GOTO_ON_ERROR(rmt_new_tx_channel(&amp;rmt_chan_config, &amp;rmt_strip-&gt;rmt_chan), err, TAG, &quot;create RMT TX channel failed&quot;);

    led_strip_encoder_config_t strip_encoder_conf = {
        .resolution = resolution,
        .led_model = led_config-&gt;led_model
    };
    ESP_GOTO_ON_ERROR(rmt_new_led_strip_encoder(&amp;strip_encoder_conf, &amp;rmt_strip-&gt;strip_encoder), err, TAG, &quot;create LED strip encoder failed&quot;);

    rmt_strip-&gt;component_fmt = component_fmt;
    rmt_strip-&gt;bytes_per_pixel = bytes_per_pixel;
    rmt_strip-&gt;strip_len = led_config-&gt;max_leds;
    rmt_strip-&gt;base.set_pixel = led_strip_rmt_set_pixel;
    rmt_strip-&gt;base.set_pixel_rgbw = led_strip_rmt_set_pixel_rgbw;
    rmt_strip-&gt;base.refresh = led_strip_rmt_refresh;
    rmt_strip-&gt;base.clear = led_strip_rmt_clear;
    rmt_strip-&gt;base.del = led_strip_rmt_del;

    *ret_strip = &amp;rmt_strip-&gt;base;
    return ESP_OK;
err:
    if (rmt_strip) {
        if (rmt_strip-&gt;rmt_chan) {
            rmt_del_channel(rmt_strip-&gt;rmt_chan);
        }
        if (rmt_strip-&gt;strip_encoder) {
            rmt_del_encoder(rmt_strip-&gt;strip_encoder);
        }
        free(rmt_strip);
    }
    return ret;
}
</code></pre>
              
            </div>
          </div><footer>

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
          
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
        <span>
          <a href="https://github.com/Awul/SWAN-MODULE" class="fa fa-code-fork" style="color: #fcfcfc"> Awul/SWAN-MODULE</a>
        </span>
    
    
    
  </span>
</div>
    <script src="../../js/jquery-3.6.0.min.js"></script>
    <script>var base_url = "../..";</script>
    <script src="../../js/theme_extra.js"></script>
    <script src="../../js/theme.js"></script>
      <script src="../../search/main.js"></script>
    <script>
        jQuery(function () {
            SphinxRtdTheme.Navigation.enable(true);
        });
    </script>

</body>
</html>
